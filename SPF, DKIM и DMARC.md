# Повышаем доставляемость почты с помощью SPF, DKIM и DMARC.

Сегодняшний мир электронной почты во многом основан на доверии, осуществляемом с помощью различных аутентификационных механизмов, таких как SPF и DKIM. Эти методы проверки предназначены для борьбы со спамом и спуфингом, но их возможности ограничены без применения DMARC, который предлагает дополнительный уровень защиты. 

Для защиты от спама используются следующие DNS записи:
- SPF (Sender Policy Framework) определяет серверы, которые могут отправлять почту от имени вашего домена. Записи SPF публикуются в DNS в виде записей TXT и определяют, каким IP-адресам разрешено отправлять электронную почту от имени домена. Она защищает поле MAIL FROM, которое передается в SMTP-сессии и не отображается почтовым клиентом.
- DKIM (DomainKeys Identified Mail) использует электронную подпись для проверки, что письмо не было изменено в процессе передачи. Запись DKIM также публикуются в виде TXT записей. Запись DKIM содержит открытый ключ. DKIM использует селектор - переменную, используемую для поиска конкретной DKIM записи для домена. У одного домена может быть несколько записей DKIM, если например используются несколько систем для отправки почты. Она защищает поле From, которое видно пользователю в почтовом клиенте.

Однако существует ещё одна запись - DMARC (Domain-based Message Authentication, Reporting, and Conformance), без которой записи SPF и DKIM не достаточно эффективны. DMARC это TXT запись с политикой проверки электронной почты с использованием информации SPF и DKIM.

## Заголовки письма
Вы наверное заметили два похожих поля MAIL FROM и From. Чем они отличаются? 
### MAIL FROM
- Команда `MAIL FROM` является частью протокола SMTP и описана в RFC 5321. Она используется во время SMTP-переговоров между почтовым клиентом (или "агентом отправки") и почтовым сервером при отправке письма. Адрес `MAIL FROM` является обратным адресом или "конвертом отправителя" электронного письма и указывается в SMTP-сессии перед передачей текста самого сообщения. Этот адрес используется принимающим почтовым сервером для отправки уведомлений о состоянии доставки (DSN) в случае проблем с доставкой (например, отказом доставки (bounces)).
- Также известен как "Return-Path" или "Envelope From".
- Команда SMTP `MAIL FROM` не обязательно должна совпадать с заголовком `From:` в самом содержимом письма. Она часто используется почтовыми службами для отслеживания доставки или реализации таких функций, как "отправка от имени" (on behalf of) или переадресации почты.
- Адрес `MAIL FROM` обычно не виден конечному получателю письма в его почтовом клиенте.  
- Пример SMTP-команды: `MAIL FROM:<sender@example.com>`

### From
- Заголовок `From:` является одним из заголовков в сообщений электронной почты, как определено в RFC 5322. Он указывает автора сообщения, то есть лицо или организацию, несущую ответственность за написание сообщения. Заголовок `From:` включается в раздел заголовка сообщения электронной почты и обычно виден получателю при просмотре сообщения в почтовом клиенте.
- Большинство получателей понимают под заголовком `From:` отправителя письма, так как он отображается на видном месте в большинстве почтовых клиентов.
- Во многих случаях адрес `From:` совпадает с адресом `MAIL FROM` (или отправителя конверта), особенно если человек отправляет письмо напрямую. Однако это не является обязательным условием.  
- Пример заголовка электронной почты: `From: John Doe <johndoe@example.com>`

На практике заголовки `MAIL FROM` и `From:` используются для различных аспектов доставки электронной почты и удобства пользователей. Заголовок `MAIL FROM` (отправитель конверта) имеет решающее значение для процесса доставки электронной почты и обратной связи, в то время как заголовок `From:` - это то, что конечный получатель обычно воспринимает как идентификатор отправителя. 

## Пример подделки отправителя
Допустим вы злоумышленник, который хочет подделать письмо от легитимного домена `bank.org`. Для начала вы регистрируете домен `fake-bank.org` и создаёте в нём DNS записи:

```
A — mail.fake-bank.org IN 1.1.1.1
MX — mail.fake-bank.org
SPF — v=spf1 mx ip4:1.1.1.1 -all
DKIM — v=dkim1; p=pubkey
```
Вы отправляете письмо клиенту притворяясь, что письмо отправлено от его банка:
```
MAIL FROM: fraud@fake-bank.org - RFC5321.MailFrom
From: manager@bank.org - RFC5322.From
DKIM-Signature: v=1; a=rsa-sha256; d=fake-bank.org; h=from:to:subject:message-id:date;
```
В нашем сценарии целью является отправка письма, которое представляется как письмо от `bank.org`, но на самом деле исходит от контролируемого злоумышленниками домена `fake-bank.org`.  

Давайте проанализируем, пройдут ли проверки SPF и DKIM, учитывая предоставленные DNS-записи и заголовки электронной почты.

### Проверка SPF (Sender Policy Framework)
- DNS запись для SPF имеет вид `v=spf1 mx ip4:1.1.1.1 -all`. Это запись означает, что  почтовые сервера из MX записи и IP-адрес 1.1.1.1 уполномочены отправлять электронные письма от имени `fake-bank.org`.
- Поскольку в заголовке `MAIL FROM` используется домен `fake-bank.org` (`fraud@fake-bank.org`), отправляющий сервер действительно уполномочен SPF записью отправлять почту для этого домена.
- Поскольку письмо не пытается подменить заголовок `MAIL FROM`, чтобы он соответствовал `bank.org`, проверка SPF для `fake-bank.org` будет пройдена.

### Проверка DKIM (DomainKeys Identified Mail)
- Заголовок `DKIM-Signature` в письме указывает `d=fake-bank.org`, что означает, что DKIM-подпись была создана с использованием закрытого ключа, соответствующего открытому ключу, опубликованному в DNS для `fake-bank.org`.
- Если предположить, что тело и заголовки, включенные в DKIM-подпись, не были изменены во время транспортировки, проверка DKIM также пройдет. Это произойдёт потому, что проверка проводится по фактическому домену отправителя (`fake-bank.org`), а не по домену, указанному в заголовке `From:`.

Таким образом без наличия DMARC записи в домене `bank.org` наше письмо-подделка прошло бы проверки SPF и DKIM, и получатель увидел бы его в папке Входящие.

Теперь поговорим про DMARC политику.

## DMARC
- DMARC проверяет SPF и DKIM на соответствие политике DMARC домена `From:`.
- Чтобы соответствовать политике (alignment) нужно чтобы домен в заголовке `From:` совпадал с доменом, подтвержденным SPF и/или доменом из параметра `d=` в подписи DKIM.
- Поскольку DMARC также смотрит на заголовок `From:` (`From: manager@bank.org`), который отличается от домена `MAIL FROM` и домена `d=` в подписи DKIM, именно здесь и будет обнаружена подделка. DMARC не пройдет для `bank.org`, потому что они отличаются. Однако если у `bank.org` нет DMARC записи или установлена политика, не обеспечивающая строгое соответствие (`p=none`), мошенническое письмо все же может быть доставлено. Без строгой политики DMARC (например, `p=quarantine` или `p=reject`) для `bank.org`, принимающий сервер может не иметь четких инструкций по обработке такого несоответствия, что делает DMARC критически важным для владельцев доменов, чтобы защитить свой домен от таких попыток подделки. 

В случае наличия DMARC, вредоносное письмо может пройти проверки SPF и DKIM, поскольку оно отправлено с сервера, авторизованного по SPF для `fake-bank.org` и содержит действительную подпись DKIM для `fake-bank.org`. Однако оно не пройдет соответствие DMARC для `bank.org`, если у `bank.org` настроена политика DMARC. Поскольку DMARC полагается на соответствие между доменом `From:` и доменами, используемыми для проверок SPF и DKIM, в данном случае такого соответствия не будет, поэтому проверка DMARC для `bank.org` будет неудачной.


## Как проверить DNS записи
Чтобы проверить записи SPF, DKIM и DMARC для домена, вы можете использовать команду `nslookup` в Windows или команду `dig` в Linux. Эти команды обычно используются для запроса системы доменных имен (DNS) с целью получения информации о сопоставлении доменных имен и IP-адресов. Для Gmail вы можете проверить записи SPF, DKIM и DMARC для домена "gmail.com", но имейте в виду, что обычно требуется проверить DKIM для определенного селектора, используемого для подписи писем, которого у вас может не быть. В этом примере мы используем селектор "20230601", чтобы продемонстрировать запрос DKIM, но в реальном сценарии вы должны заменить "20230601" на фактический селектор, предоставленный отправителем электронной почты. Название селектора можно узнать открыв детали письма и найти параметр `s=` в заголовке `DKIM-Signature`.

### На Windows (с помощью nslookup):
Откройте командную строку и выполните следующие команды:
- SPF-запись: 
```
nslookup -type=txt gmail.com
```
- DKIM-запись:
```
nslookup -type=txt 20230601._domainkey.gmail.com
```
- DMARC-запись:
```
nslookup -type=txt _dmarc.gmail.com
```

### В Linux (с помощью dig):
Откройте терминал и выполните следующие команды:
- SPF-запись:
```
dig +short txt gmail.com
```
- DKIM-запись:
```
dig +short txt 20230601._domainkey.gmail.com
```
- DMARC-запись:
```
dig +short txt _dmarc.gmail.com
```
Опция `+short` в команде `dig` предоставит вам только информацию о записи без дополнительных выходных данных.

## Выводы
- DMARC необходим для установки политики в случае несоответствия SPF и DKIM.
- DMARC включает в себя механизм соответствия (alignment) между полями From и MAIL FROM.
- DMARC указывает действие (p=), которое должен совершить получатель письма, если DKIM и SPF не проходят проверку.
- Чтобы прошла DKIM проверка домен в DKIM заголовке письма (DKIM-Signature: a=rsa-sha1;s=selector;d=fake-bank.org) должен соответствовать домену в поле FROM (bank.org).
- Чтобы прошла SPF проверка домен в RFC5321.MailFrom (MAIL FROM) или RFC5321.EHLO/HELO поле SMTP должен соответствовать домену в поле FROM (bank.org).
- Если ни одна из проверок на соответвтсие не проходит, то клиент применяет политику, указанную в записи DMARC.

В реальном мире вам не понадобится вручную проверять SPF, DKIM или DMARC при получении письма, поскольку за вас это делает почтовый сервер. Однако если вы управляете собственным доменом, эти проверки становятся важными чтобы снизить риск того, что ваши письма будут отмечены как спам, и для обеспечения высокой степени доставки исходящих писем.
